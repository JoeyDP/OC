digraph Studieprogramma{
	node [shape="rect", pin=true, style=filled,color=white, height=0.7, fixedsize=true];
	graph [ranksep="6", nodesep="0.2" splines=true, concentrate=true];
	edge [constraint=false];

	/*
	3 SP = 0.25
	6 SP = 0.7
	9 SP = 1.15
	12 SP = 1.6
	*/

	rankdir="LR"

	{% for year in years %}
	subgraph cluster_{{ year.id }}{
		label = "{{ year.name }}"
		style=filled;
		color=lightgrey;

        {% for semester in year.semesters %}
            {% for course in semester.courses %}
                {% if course.moved and not absolute %}
                    {% set color = "green" %}
                {%  else %}
                    {% set color = "white" %}
                {% endif %}
                {{ course.id }} [label="{{ course.shortName }}", height={{ course.height }}, color={{ color }}];
            {% endfor %}

			{% if includeWorkload %}
            	{{ year.id }}_{{ semester.id }}_ratio [height=0.25, style=striped, color="forestgreen;{{ semester.spWork/semester.spTotal }}:orange", label="{{ semester.spWork }}{%if semester.spWork<10%} {% endif %}       {{ semester.spTheory }}"]
			{% endif %}

            {% if not loop.last %}
                {{ year.id }}_sem [height=0, fixedsize=true, label="", color=black];
            {% endif %}
        {% endfor %}
	}

	{% endfor %}

	# align clusters by adding invis edge between top items.
	{
		edge	[constraint=true, style=invis];
        {% for i in range(years|length - 1) %}
            {{ years[i].courses[0].id }}:ne -> {{ years[i+1].courses[0].id }}:nw;
        {% endfor %}
	}

    {% for year in years %}
        # =====================
        # =	dependencies {{ year.name }}	=
        # =====================
        {% for course in year.courses %}
            # {{ course.shortName|safe }}
            {% for dep in course.getDependencies(absolute=absolute) %}
                {% if absolute %}
                    {% set color = "black" %}
                {% elif dep.isNew() %}
                    {% set color = "green" %}
                {% elif dep.isChanged() %}
                    {% set color = "blue" %}
                {% elif dep.isRemoved() %}
                    {% set color = "red" %}
                {% else %}
                    {% set color = "black" %}
                {% endif %}
                {# Connect same year courses on left side#}
                {% if dep.source.year == dep.dest.year %}
                    {% set side = 'e' %}
                {% else %}
                    {% set side = 'w' %}
                {% endif %}
                {% if highlightCourse %}
                    {% if highlightCourse == dep.source or highlightCourse == dep.dest %}
                        {% set penwidth = "3" %}
                    {% else %}
                        {% set penwidth = "0.1" %}
                    {% endif %}
                {% else %}
                    {% set penwidth = "1" %}
                {% endif %}
                {{ dep.source.id }}:e -> {{ dep.dest.id }}:{{ side }} [color={{ color }}{% if dep.isSoft() %}, style="dashed"{% endif %}, penwidth={{ penwidth }}];
            {% endfor %}
        {% endfor %}
    {% endfor %}


}
